// User controller
import { Request, Response, NextFunction } from 'express';
import { userService } from '../services/userService';
import { z } from 'zod';

const updateProfileRequestSchema = z.object({
  name: z.string().min(1).optional(),
  email: z.string().email().optional(),
  password: z.string().min(6).optional(),
});

export const userController = {
  async getProfile(req: Request, res: Response, next: NextFunction) {
    try {
      const user = req.user;
      if (!user) return res.status(401).json({ error: 'Not authenticated' });
      const userProfile = await userService.toUserProfile(user);
      res.json(userProfile);
    } catch (err) {
      next(err);
    }
  },

  async updateProfile(req: Request, res: Response, next: NextFunction) {
    try {
      const parsed = updateProfileRequestSchema.safeParse(req.body);
      if (!parsed.success) {
        return res.status(400).json({ error: 'Invalid request', details: parsed.error.errors });
      }
      const user = req.user;
      if (!user) return res.status(401).json({ error: 'Not authenticated' });
      const updated = await userService.updateProfile(user.id, parsed.data);
      if (!updated) return res.status(404).json({ error: 'User not found' });
      const userProfile = await userService.toUserProfile(updated);
      res.json(userProfile);
    } catch (err) {
      next(err);
    }
  },
};

