// User service
import { User } from '../entities/User';
import { v4 as uuidv4 } from 'uuid';
import bcrypt from 'bcryptjs';

// In-memory user store (replace with DB in prod)
const users: User[] = [];

export const userService = {
  async findByEmail(email: string): Promise<User | undefined> {
    return users.find(u => u.email === email);
  },
  async findById(id: string): Promise<User | undefined> {
    return users.find(u => u.id === id);
  },
  async create(email: string, password: string, name: string): Promise<User> {
    const passwordHash = await bcrypt.hash(password, 10);
    const now = new Date();
    const user: User = {
      id: uuidv4(),
      email,
      passwordHash,
      name,
      createdAt: now,
      updatedAt: now,
    };
    users.push(user);
    return user;
  },
  async updateProfile(id: string, data: { name?: string; email?: string; password?: string }): Promise<User | undefined> {
    const user = await this.findById(id);
    if (!user) return undefined;
    if (data.name) user.name = data.name;
    if (data.email) user.email = data.email;
    if (data.password) user.passwordHash = await bcrypt.hash(data.password, 10);
    user.updatedAt = new Date();
    return user;
  },
  async toUserProfile(user: User) {
    return {
      id: user.id,
      email: user.email,
      name: user.name,
      createdAt: user.createdAt,
    };
  },
};

